(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pagesmessage/userMsg"],{"0dbf":function(t,e,i){"use strict";i.r(e);var n=i("501b"),s=i.n(n);for(var o in n)"default"!==o&&function(t){i.d(e,t,(function(){return n[t]}))}(o);e["default"]=s.a},"396d":function(t,e,i){"use strict";i.r(e);var n=i("ef90"),s=i("0dbf");for(var o in s)"default"!==o&&function(t){i.d(e,t,(function(){return s[t]}))}(o);i("5a3e");var r,a=i("f0c5"),c=Object(a["a"])(s["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],r);e["default"]=c.exports},"501b":function(t,e,i){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n,s=r(i("a34a")),o=r(i("591c"));function r(t){return t&&t.__esModule?t:{default:t}}function a(t,e,i,n,s,o,r){try{var a=t[o](r),c=a.value}catch(u){return void i(u)}a.done?e(c):Promise.resolve(c).then(n,s)}function c(t){return function(){var e=this,i=arguments;return new Promise((function(n,s){var o=t.apply(e,i);function r(t){a(o,n,s,r,c,"next",t)}function c(t){a(o,n,s,r,c,"throw",t)}r(void 0)}))}}function u(t){return g(t)||f(t)||m(t)||d()}function d(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function m(t,e){if(t){if("string"===typeof t)return l(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?l(t,e):void 0}}function f(t){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}function g(t){if(Array.isArray(t))return l(t)}function l(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}var h,p=!0,_=[],v=0,y="",S=function(){Promise.all([i.e("common/vendor"),i.e("components/jyf-parser/jyf-parser")]).then(function(){return resolve(i("28cc"))}.bind(null,i)).catch(i.oe)},b=t.getRecorderManager(),w={components:{jyfParser:S},data:function(){var e=this.$Config("APIHOST");return{kf_id:"",BASE_URL:e,massage_type:1,user_type:1,title:"",onKeyboard:!1,imgUrl:this.$apiurl,user:{},autoHeight:!0,kfdata:[],limitHour:!1,textMsg:"",IMG_URL:this.IMG_URL,scrollAnimation:!1,scrollTop:0,scrollToView:"",friendId:"",job_position_id:"",msgList:[],msgImgList:[],emojiList:o.default,isstop:!0,msg_code:[{id:0,uid:-1,username:"系统助手",face:this.imgUrl+"static/miniwechat/none4x3.jpg",time:"",type:"system",content:"您好，有问题请留言"}],myuid:0,RECORDER:t.getRecorderManager(),isVoice:!1,voiceTis:"按住 说话",recordTis:"手指上滑 取消发送",recording:!1,willStop:!1,jobData:[],initPoint:{identifier:0,Y:0},recordTimer:null,recordLength:0,AUDIO:t.createInnerAudioContext(),playMsgid:null,VoiceTimer:null,showEmji:"",setList:[],page:1,isLoading:!1}},onLoad:function(e){var i=this;n=this,this.kf_id=e.kfid,this.friendId=e.friendId,v=e.kfid,this.job_position_id=e.job_position_id,e.userName&&(this.title=e.userName),this.AUDIO.onEnded((function(t){i.playMsgid=null})),this.RECORDER.onStart((function(t){i.recordBegin(t)})),b.onStop((function(e){t.saveFile({tempFilePath:e.tempFilePath,success:function(t){var e=t.savedFilePath;n.recordEnd(e)}})})),this.user_data=t.getStorageSync("USERINFO"),this.user_data?(this.myuid=this.user_data.id,this.user.id=this.user_data.id,this.user.name=this.user_data.user_nickname,this.user.avatar=this.user_data.head_img,this.user.group=1):t.navigateTo({url:"/pagessignup/wechat/wxlog"}),this.user_type=this.user_data.user_type,this.changeStatus(),this.addFriend(),this.getMsgList(),setTimeout((function(){i.connectSocket()}),500)},filters:{msg_img:function(t){var e="";return t&&t.indexOf("img[")>=0&&(e=t.substr(4,t.length-5)),e}},onUnload:function(){this.changeStatus(),t.$emit("updata",{}),h&&h.stop(),t.$emit("openAll",{})},methods:{toReport:function(){t.navigateTo({url:"/pagesHome/complaint?job_id="+this.kf_id+"&&job_type=1"})},hideKeyboard:function(e){t.hideKeyboard(),this.onKeyboard=!1},lineChange:function(t){t.detail.lineCount>3&&(this.autoHeight=!1)},addFriend:function(t){1!=t&&this.$Request.post(this.$api.msg.addFriend,{user_id:this.kf_id,job_position_id:this.job_position_id}).then((function(t){t.code}))},connectSocket:function(){var e=this;t.connectSocket({url:"wss://websocket.chongdarenli.com?from_id="+this.user.id+"&to_id="+this.kf_id}),console.log("websocket已打开"),t.onSocketOpen((function(i){e.user_data.id,e.user.name,e.user.avatar,e.user.group,e.user_type;p=!0;for(var n=0;n<_.length;n++)e.sendSocketMessage(_[n]);_=[],setInterval((function(){t.sendSocketMessage({data:"pong",success:function(t){}})}),1e4)})),t.onSocketError((function(t){console.log("WebSocket连接打开失败，请检查！")})),t.onSocketMessage((function(i){var n=this;if(console.log(i),"success"!=i.data){e.changeStatus();var s=JSON.parse(i.data);if(!s)return;t.$emit("updata",{}),console.log(s),"saveMessage"==s.event||"message"==s.event?(e.msgList.push(s),e.msgList.map((function(t,e){t.updateTime=n.$Common.formatTime(t.update_time,"Y-M-D h:m:s")})),console.log(e.msgList),e.$nextTick((function(){e.scrollToView="msg2",e.$nextTick((function(){e.scrollAnimation=!0,e.scrollToView="msg"+e.msgList[e.msgList.length-1].aid})),t.$emit("updata",{})}))):s.event}})),t.onSocketClose((function(t){console.log("WebSocket 已关闭！",t)}))},getMsgList:function(){var t=this,e=this;if(!this.isLoading){var i=e.kf_id;this.isLoading=!0,this.$Request.post(this.$api.msg.msg_List,{to_id:i,page:this.page,list_rows:30}).then((function(n){if(e.addFriend(i),1==n.code)if(n.data.data.length>0){var s,o=n.data.data;if(o.map((function(t,e){t["id"]=e+1})),s=o[o.length-1].aid,e.msgList=[].concat(u(o),u(e.msgList)),e.msgList.map((function(e,i){e.updateTime=t.$Common.formatTime(e.create_time,"Y-M-D h:m:s"),e["id"]=i+1})),e.$nextTick((function(){e.scrollAnimation=!1,e.scrollToView="msg2",e.$nextTick((function(){e.scrollToView="msg"+s,setTimeout((function(){e.scrollAnimation=!0}),1e3)}))})),n.data.last_page<=e.page)return;t.page++}else t.msgList=t.msg_code;t.isLoading=!1}))}},sendSocketMessage:function(e){var i=this;p?t.sendSocketMessage({data:e,success:function(t){console.log(t);var n=JSON.parse(e);n&&i.msgList.push(n)},fail:function(t){i.$Common.toast("连接失败，请退出重试")}}):_.push(e)},sendMsg:function(t,e){var i=new Date,n=this.msgList.length;n++;var s="";s=(new Date).getTime();var o={id:n,aid:s,username:this.user.name,face:this.user.avatar,time:i.getHours()+":"+i.getMinutes(),msg_type:e,to_id:parseInt(v),msg:t,from_name:this.user.name,from_avatar:this.user.avatar,updateTime:this.$Common.formatTime(s,"Y-M-D h:m:s")};this.screenMsg(o);var r=JSON.stringify({id:n,aid:s,event:"saveMessage",to_id:parseInt(v),to_name:y,content:t,msg_type:e,from_name:this.user.name,from_id:this.user.id,from_avatar:this.user.avatar,updateTime:this.$Common.formatTime(s/1e3,"Y-M-D h:m:s")});console.log(r),this.sendSocketMessage(r)},setPicSize:function(t){if("object"==typeof t.msg)return t;var e=t.msg,i=/.*\[(.*)\]/,n=e.match(i)?e.match(i)[1]:"";return t.msg=n||t.msg,t},changeStatus:function(){this.$Request.post(this.$api.msg.user_token_msg,{from_id:this.kf_id}).then((function(t){}))},screenMsg:function(e){switch(this.changeStatus(),t.$emit("updata",{}),e.uid,this.myuid,this.$nextTick((function(){n.scrollToView="msg2",n.$nextTick((function(){n.scrollAnimation=!0,n.scrollToView="msg"+e.aid}))})),e.type){case"text":this.addTextMsg(e);break;case"voice":this.addVoiceMsg(e);break;case"img":this.addImgMsg(e);break}},chooseEmoji:function(){this.hideKeyboard(),this.showEmji="showEmoji"==this.showEmji?"hideEmoji":"showEmoji"},hideEmoji:function(){this.showEmji="showEmoji"==this.showEmji?"hideEmoji":"",this.hideKeyboard()},addEmoji:function(t){this.textMsg+=t.alt},sendText:function(){if(this.hideEmoji(),this.textMsg){var t=this.replaceEmoji(this.textMsg);this.sendMsg(t,"text"),this.textMsg=""}},replaceEmoji:function(t){var e=this;t=1!=this.massage_type?t.replace(/emoji/g," "):this.sysReplaceEmoji(t);var i=t.replace(/\[([^(\]|\[)]*)\]/g,(function(t,i){for(var n=0;n<e.emojiList.length;n++)for(var s=e.emojiList[n],o=0;o<s.length;o++){var r=s[o];if(r.alt==t){var a=e.IMG_URL+"static/images//emoji/",c='<img src="'+a+r.url+'">';return c}}}));return i},sysReplaceEmoji:function(t){return t=(t||"").replace(/&(?!#?[a-zA-Z0-9]+;)/g,"&amp;").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/@(\S+)(\s+?|$)/g,'@<a href="javascript:;">$1</a>$2').replace(/emoji\[([^\s\[\]]+?)\]/g,(function(t){var e=t.replace(/^emoji/g,"");return'<img alt="'+e+'" title="'+e+'" src="'+faces[e]+'">'})).replace(/img\[([^\s]+?)\]/g,(function(t){return'<img class="layui-whisper-photos" src="'+t.replace(/(^img\[)|(\]$)/g,"")+'" width="100px" height="100px">'})).replace(/file\([\s\S]+?\)\[[\s\S]*?\]/g,(function(t){var e=(t.match(/file\(([\s\S]+?)\)\[/)||[])[1],i=(t.match(/\)\[([\s\S]*?)\]/)||[])[1];return e?'<a class="layui-whisper-file" href="'+e+'" download target="_blank"><i class="layui-icon">&#xe61e;</i><cite>'+(i||e)+"</cite></a>":t})).replace(/\n/g,"<br>"),t},chooseImage:function(){var t=this;return this.hideEmoji(),this.$Request.uploadImg((function(e){var i="img["+e.data[0].path+"]";t.sendMsg(i,"img")})),!1},addSystemTextMsg:function(t){this.msgList.push(t)},addTextMsg:function(t){this.msgList.push(t)},addVoiceMsg:function(t){this.msgList.push(t)},addImgMsg:function(t){var e=this.setPicSize(t);this.msgImgList.push(e.msg),this.msgList.push(e)},showPic:function(e){var i=[],n=e.content;n.indexOf("img[")>=0&&i.push(n.substr(4,n.length-5)),t.previewImage({indicator:"none",current:n,urls:i})},playVoice:function(e){h=t.createInnerAudioContext(),h.autoplay=!0,h.src=JSON.parse(e.content).url,h.onPlay((function(){}))},voiceBegin:function(t){b.start(),this.initPoint.Y=t.touches[0].clientY},recordBegin:function(t){var e=this;this.recording=!0,this.voiceTis="松开 结束",this.recordLength=0,this.recordTimer=setInterval((function(){e.recordLength++}),1e3)},voiceCancel:function(){},voiceIng:function(e){if(this.recording){var i=e.touches[0];this.initPoint.Y-i.clientY>=t.upx2px(100)?(this.willStop=!0,this.recordTis="松开手指 取消发送"):(this.willStop=!1,this.recordTis="手指上滑 取消发送")}},voiceEnd:function(t){this.recording&&(this.recording=!1,this.voiceTis="按住 说话",this.recordTis="手指上滑 取消发送",b.stop())},recordEnd:function(e){var i=this;return c(s.default.mark((function n(){var o,r,a,c,u,d,m;return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(clearInterval(i.recordTimer),o=i,o.willStop){n.next=18;break}if(r={length:0,url:e},a={},c=parseInt(i.recordLength/60),u=o.recordLength%60,c=c<10?"0"+c:c,u=u<10?"0"+u:u,r.length=c+":"+u,!(c<=0&&u<=0)){n.next=13;break}return i.$Common.toast("录音时间过短"),n.abrupt("return");case 13:d={},m=e,d["uploadTask"]=t.uploadFile({url:i.BASE_URL+o.$api.common.singupAudio,filePath:m,name:"file[]",formData:a,success:function(e){if(200==e.statusCode){var i=JSON.parse(e.data);r.url=i.data[0].path;var n=JSON.stringify(r);console.log(n,"----语音信息======"),setTimeout((function(){o.sendMsg(n,"voice")}),100)}else t.showToast({title:e.errMsg,icon:"none"})},fail:function(e){t.showToast({title:"音频上传失败，请稍后再试."+e.errMsg,icon:"none"})}}),n.next=18;break;case 18:i.willStop=!1;case 19:case"end":return n.stop()}}),n)})))()},switchVoice:function(){this.hideEmoji(),this.isVoice=!this.isVoice},discard:function(){},getCacheChat:function(e){return t.getStorageSync(e)},setCacheChat:function(e){t.setStorageSync(e.key,e.data)}}};e.default=w}).call(this,i("543d")["default"])},"5a3e":function(t,e,i){"use strict";var n=i("88f7"),s=i.n(n);s.a},"5f40":function(t,e,i){"use strict";(function(t){i("652a");n(i("66fd"));var e=n(i("396d"));function n(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=i,t(e.default)}).call(this,i("543d")["createPage"])},"88f7":function(t,e,i){},ef90:function(t,e,i){"use strict";var n;i.d(e,"b",(function(){return s})),i.d(e,"c",(function(){return o})),i.d(e,"a",(function(){return n}));var s=function(){var t=this,e=t.$createElement,i=(t._self._c,t.__map(t.msgList,(function(e,i){var n=t.__get_orig(e),s=e.from_id&&e.from_id&&e.from_id==t.myuid&&"msg"!=e.msg_type&&"voice"==e.msg_type?JSON.parse(e.content):null,o=e.from_id&&e.from_id&&e.from_id==t.myuid&&"msg"!=e.msg_type&&"img"==e.msg_type?t._f("msg_img")(e.content):null,r=e.from_id&&e.from_id&&e.from_id!=t.myuid&&t.kf_id==e.from_id&&"msg"!=e.msg_type&&"voice"==e.msg_type&&""!=e.content?JSON.parse(e.content):null,a=e.from_id&&e.from_id&&e.from_id!=t.myuid&&t.kf_id==e.from_id&&"msg"!=e.msg_type&&"img"==e.msg_type?t._f("msg_img")(e.content):null;return{$orig:n,g0:s,f0:o,g1:r,f1:a}})));t._isMounted||(t.e0=function(e){t.onKeyboard=!0}),t.$mp.data=Object.assign({},{$root:{l0:i}})},o=[]}},[["5f40","common/runtime","common/vendor"]]]);